---
title: Estimating extinction time from the fossil record accounting for measurement error
author: "David Warton"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE,echo = TRUE)
```

## Problem statement

Often we wish to estimate the time of extirpation of a species using the fossil record -- we have a sequence of estimated dates for the species, measured with error (whose magnitude is assumed to be known). For example, say we have the following data (from a red deer sub-species, sourced from supplementary material for Cooper et al 2015; Science):
```{r data input}
deer = c(14729, 14903, 14743, 14738, 14739, 14741, 14732, 14720, 14657, 14638, 14635, 14631, 14642, 14613, 14577, 14544, 14539, 14545, 14541, 14541, 14507, 14490, 14496, 14440, 14389, 14389, 14413, 14361, 14391, 14373, 14323, 14278, 14306, 14301, 14229, 14101, 14068, 14035, 14057, 14018, 13999, 13951, 13939, 13896, 13835, 13819, 13660, 13485, 13482, 12714, 12514, 12227, 12202, 12122, 12124)
deerSds = c(333, 176, 305, 301, 282, 278, 264, 261, 286, 309, 311, 295, 245, 256, 293, 252, 259, 302, 290, 289, 282, 240, 299, 279, 224, 230, 287, 216, 273, 284, 299, 251, 293, 301, 392, 268, 253, 244, 128, 161, 203, 175, 115, 158, 194, 207, 85, 98, 78, 55, 115, 179, 186, 243, 252)
```

There are two main sources of uncertainty to account for:

1. _Sampling error_, that is, the last time the species was seen (12122 years ago) is not necessarily the last time it was there.

1. _Measurement error_, because fossil ages were measured with uncertainty (whose standard deviation is assumed to be known in the below).

Currently, methods in the literature account for one or other of these quantities, but typically not both. Classical estimators (Strauss, McInerney's, _etc_) account for sampling error only, GRIWM constructs confidence intervals which account for measurement error but don't actually deal with sampling error.

The `est_cutt` function in the `reginv` package accounts for both, and produces nearly unbiased estimates of extinction time and confidence intervals that are close to exact, when assumptions are satisfied.

## Using the `est_cutt` function

To use the `est_cutt` function from the `reginv` package, you need to specify as input:

- `ages`, a vector of estimated fossil ages
- `sd`, a vector of measurement error standard deviations (scalar would also be OK, assuming this is constant)
- `K`, the oldest time for a fossil to be considered for inclusion in this dataset. If it is not clear what this is you could always remove the oldest fossil and set `K` equal to its value.

There are other arguments you can play with as well, consult the help file for details.

```{r fit model}
# if required, devtools::install_github("dwarton/reginv")
library(reginv)
ft = est_cutt(deer,deerSds,K=15000) # takes maybe a minute to run
ft
```

This returns a point estimate for extinction of `r format(ft$theta[2], scientific=FALSE)` BP, and by default, it also includes a 95% confidence interval for it, which in this case extends a few centuries either side of `r format(ft$theta[2], scientific=FALSE)` BP.

This code takes a fair while to run (maybe a minute?) because it is doing a lot of work in the background. By default, unless measurement error is large, it uses a new method called _regression inversion_ (`method="reginv"`) which computes a maximum likelihood estimator under the CUTT model (see below), then repeatedly simulates new data at different potential extinction times in order to find a range that is plausible considering the estimators obtained from simulated data.

A faster alternative method is to use inversion form the chi-squared distribution
```{r fit modelMLE}
est_cutt(deer,deerSds,K=15000,method="mle")
```

This ended up returning similar values, but in cases where measurement error is small it tends to return confidence intervals that are too short.


## Model - the CUTT distribution

The `est_cutt` function uses a new technique based on modelling fossil ages using a Compound Uniform -- Truncated T (CUTT) distribution. Using this distribution assumes

- That, for a fossil of a given age, measurement error estimating its age follows a distribution that is Student's T multiplied by the provided standard deviation, truncated such that observed age is less than K

- That fossil dates are uniformly distributed over the interval of allowable dates

A truncated normal distribution could also be used (and is a special case of the T, where degrees of freedom is infinite) but I have noticed that measurement error seems to be long-tailed relative to the normal so the T tends to provide a better fit to data. Departures from uniform deposition rate could also be considered but usually I think there is not enough information to estimate a plausible alternative.

Considering our red deer dataset:
```{r hist}
hist(deer)
```

Note that the histogram has a left-skewed distribution. This is what we would expect from a CUTT distribution:

```{r dcutt}
library(reginv)
xs=seq(10000,15000,length=100)
ds = dcutt(xs,12000,K=15000,sd=mean(deerSds),df=3)
plot(xs,ds,type="l")
```

The left-tail comes from measurement error. The assumed extinction time for this particular distribution is about halfway down this curve at 12000. The curve flattens out to the right away from the extinction time, due to the uniform assumption on deposition rates.

Note that the above curve is steeper than what is suggested by the histogram -- this suggests that either the uniform deposition assumption is not valid, with a decay in deposition rates as we approach extinction, or it means that measurement error variance was underestimated.

As with any parametric assumptions we make of data, we can check this against the data we have to see if it is plausible -- I would suggest doing so using a qqplot as follows:

```{r qqplot}
# install.packages("ecostats") #if you don't already have the ecostats package installed
ecostats::qqenvelope(qnorm(pcutt(deer,ft$theta[2],sd=deerSds,K=15000,df=ft$df)))
```

This code constructs residuals for your data, from the CUTT model fitted to it, and maps them to a standard normal distribution to make it easier visually to check assumptions. The shaded region is a 95% global envelope, meaning that we expect all points to be inside it if assumptions were satisfied. In the above plot we have a couple of points just outside, suggesting modest evidence of violation of assumptions in the CUTT model, with a couple of the more recent fossils having slightly lower values than expected by the CUTT model. This doesn't look like a big problem.
